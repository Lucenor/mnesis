name: Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g. 0.2.0)"
        required: true
        type: string
      notes:
        description: "Release notes (markdown bullet points). Leave blank to auto-generate from git log."
        required: false
        type: string

permissions:
  contents: read
  id-token: write  # PyPI OIDC

jobs:
  # ── 1. Validate inputs ────────────────────────────────────────────────────
  validate:
    name: Validate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version format, ordering, and uniqueness
        id: check
        run: |
          VERSION="${{ inputs.version }}"

          # Must be X.Y.Z (no leading v)
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Version '$VERSION' is not valid semver (expected X.Y.Z)"
            exit 1
          fi

          TAG="v${VERSION}"

          # Tag must not already exist
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag '$TAG' already exists"
            exit 1
          fi

          # Changelog must not already have an entry for this version
          if grep -q "^## ${VERSION}" docs/changelog.md; then
            echo "::error::docs/changelog.md already has an entry for ${VERSION}"
            exit 1
          fi

          # Version must be strictly greater than the latest release tag
          LAST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
          if [ -n "$LAST_TAG" ]; then
            LAST_VERSION="${LAST_TAG#v}"
            python3 - <<PYEOF
          import sys

          def parse(v):
              return tuple(int(x) for x in v.split('.'))

          new  = parse("${VERSION}")
          last = parse("${LAST_VERSION}")
          if new <= last:
              print(f"::error::Version ${VERSION} is not greater than last release ${LAST_VERSION}")
              sys.exit(1)
          print(f"Version ${VERSION} > ${LAST_VERSION} ✓")
          PYEOF
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}"         >> "$GITHUB_OUTPUT"

  # ── 2. Full CI gate ───────────────────────────────────────────────────────
  lint:
    name: Lint & Format
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --dev

      - name: Ruff lint
        run: uv run ruff check src/ tests/

      - name: Ruff format check
        run: uv run ruff format --check src/ tests/

  typecheck:
    name: Type Check
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --dev

      - name: mypy
        run: uv run mypy src/mnesis

  test:
    name: Tests (Python ${{ matrix.python-version }})
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests
        env:
          MNESIS_MOCK_LLM: "1"
        run: uv run pytest

  # ── 3. Release ────────────────────────────────────────────────────────────
  release:
    name: Release v${{ needs.validate.outputs.version }}
    needs: [validate, lint, typecheck, test]
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - name: Generate release token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.12"

      - name: Configure git identity
        run: |
          git config user.name  "Mnesis Release Bot"
          git config user.email "mnesis-release-bot[bot]@users.noreply.github.com"

      # ── 3a. Resolve release notes ────────────────────────────────────────
      - name: Resolve release notes
        id: notes
        run: |
          NOTES="${{ inputs.notes }}"

          if [ -z "$NOTES" ]; then
            LAST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
            if [ -n "$LAST_TAG" ]; then
              NOTES=$(git log "${LAST_TAG}..HEAD" --pretty=format:"- %s" --no-merges)
            else
              NOTES=$(git log HEAD --pretty=format:"- %s" --no-merges)
            fi
          fi

          printf '%s' "$NOTES" > /tmp/release_notes.md

          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # ── 3b. Bump version in pyproject.toml ──────────────────────────────
      - name: Bump version in pyproject.toml
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" pyproject.toml
          grep '^version = ' pyproject.toml

      # ── 3c. Prepend changelog entry ──────────────────────────────────────
      - name: Update docs/changelog.md
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          NOTES: ${{ steps.notes.outputs.notes }}
        run: |
          python3 - <<'PYEOF'
          import pathlib, os, datetime

          path    = pathlib.Path("docs/changelog.md")
          text    = path.read_text()
          lines   = text.splitlines(keepends=True)
          version = os.environ["VERSION"]
          date    = datetime.date.today().strftime("%Y-%m-%d")
          notes   = os.environ["NOTES"].strip()

          insert = 1
          for i, line in enumerate(lines):
              if i == 0:
                  continue
              if line.strip() == "" and i == 1:
                  insert = 2
                  break

          new_section = f"## {version} — {date}\n\n{notes}\n\n"
          lines.insert(insert, new_section)
          path.write_text("".join(lines))
          print(f"Prepended changelog entry for {version}")
          PYEOF

      # ── 3d. Build distribution ───────────────────────────────────────────
      # Build before pushing so a build failure leaves the repo untouched.
      - name: Build package
        run: uv build

      # ── 3e. Commit, tag, push ────────────────────────────────────────────
      - name: Commit and tag release
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"

          git add pyproject.toml docs/changelog.md
          git commit -m "chore: release ${VERSION}"
          git tag -a "$TAG" -m "Release ${VERSION}"
          git push origin main
          git push origin "$TAG"

      # ── 3f. Create GitHub Release ────────────────────────────────────────
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          gh release create "$TAG" dist/* \
            --title "mnesis ${TAG}" \
            --notes-file /tmp/release_notes.md

      # ── 3g. Publish to PyPI ──────────────────────────────────────────────
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # ── 4. Rollback (runs only if release job fails) ──────────────────────────
  rollback:
    name: Rollback failed release
    needs: release
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Generate release token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ steps.app-token.outputs.token }}

      - name: Configure git identity
        run: |
          git config user.name  "Mnesis Release Bot"
          git config user.email "mnesis-release-bot[bot]@users.noreply.github.com"

      - name: Delete GitHub Release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          TAG="v${{ inputs.version }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" --yes
            echo "Deleted GitHub Release $TAG"
          else
            echo "No GitHub Release found for $TAG, skipping"
          fi

      - name: Delete remote tag
        run: |
          TAG="v${{ inputs.version }}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            git push origin ":refs/tags/${TAG}"
            echo "Deleted remote tag $TAG"
          else
            echo "No remote tag $TAG found, skipping"
          fi

      - name: Revert release commit
        run: |
          VERSION="${{ inputs.version }}"
          git fetch origin main
          COMMIT=$(git log origin/main --oneline | awk "/chore: release ${VERSION}$/ {print \$1; exit}")
          if [ -n "$COMMIT" ]; then
            git revert --no-edit "$COMMIT"
            git push origin main
            echo "Reverted release commit $COMMIT"
          else
            echo "No release commit found on main for ${VERSION}, skipping"
          fi
